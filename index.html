<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ポケモン素早さ早見表（修正版）</title>
<style>
:root{
  --bg:#ffffff;
  --accent:#ff3b3b; /* 赤：通常 */
  --change-blue:#2b85ff; /* 青：変化後 */
  --text:#111;
  --muted:#666;
  --card:#fff;
  --max-width:1200px;
  font-family: "Noto Sans JP", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  --col-width:70px; /* 狭め */
  --col-gap:6px;    /* かなり詰める（青丸オフセットを考慮） */
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);padding-bottom:64px}
.app{max-width:var(--max-width);margin:0 auto;padding:12px}
header{display:flex;align-items:center;gap:12px;padding:8px 0}
#logo{font-weight:700;font-size:18px}
.tabs{display:flex;gap:8px;border-bottom:1px solid #eee}
.tab{padding:10px 14px;cursor:pointer;border-radius:8px 8px 0 0;color:var(--muted)}
.tab.active{background:#fff;border:1px solid #eee;border-bottom:1px solid #fff;color:var(--text);font-weight:700}
.controls{display:flex;gap:8px;align-items:center;width:100%;position:relative;margin-top:10px}
.search-wrap{flex:1;position:relative}
#search-box{width:100%;padding:10px 12px;border:1px solid #ddd;border-radius:8px;font-size:16px}
.suggestions{position:absolute;left:0;right:0;background:#fff;border:1px solid #eee;border-top:none;max-height:220px;overflow:auto;z-index:30}
.suggestions div{padding:8px 10px;cursor:pointer}
.suggestions div:hover{background:#fafafa}

/* layout */
.main{display:flex;gap:12px;margin-top:12px}
.left-column{width:160px}
.axis-title{font-size:14px;color:var(--muted);margin-bottom:8px}
.list-area{display:flex;flex-direction:column;gap:8px;max-height:640px;overflow:auto}
.pokemon-card{display:flex;align-items:center;gap:8px;background:var(--card);border:1px solid #eee;padding:8px;border-radius:8px}
.poke-icon{width:44px;height:44px;border-radius:8px;background:#f5f5f5;display:flex;align-items:center;justify-content:center;font-weight:700;color:#777;overflow:hidden}
.poke-icon img{width:100%;height:100%;object-fit:cover;display:block}
.poke-name-vertical{font-weight:700;line-height:1;display:flex;flex-direction:column;align-items:center;gap:0;padding:0 2px}
.poke-name-vertical span{display:block}
.card-meta{margin-left:auto;display:flex;flex-direction:column;align-items:flex-end;gap:6px}
.remove-btn{background:transparent;border:1px solid #f0f0f0;padding:6px 8px;border-radius:6px;font-size:12px;color:var(--muted);cursor:pointer}
.remove-btn:hover{background:#fafafa}
.base-speed{font-size:12px;color:var(--muted)}

/* canvas */
.canvas-wrap{flex:1;min-height:460px;background:#fff;border:1px solid #eee;border-radius:8px;padding:12px;display:flex;flex-direction:column}
.svg-area{flex:1;display:flex;align-items:stretch;justify-content:center;padding:6px;overflow:auto}
.legend{display:flex;gap:12px;align-items:center;padding-top:8px;font-size:13px;color:var(--muted)}
.legend .dot{width:14px;height:14px;border-radius:50%;display:inline-block}

/* settings tab */
.settings-wrap{flex:1;min-height:460px;background:#fff;border:1px solid #eee;border-radius:8px;padding:12px;display:flex;flex-direction:column}
.settings-list{display:flex;flex-direction:column;gap:8px;padding:8px 0;max-height:520px;overflow:auto}
.setting-card{display:flex;align-items:center;gap:12px;padding:8px;border:1px solid #eee;border-radius:8px;background:#fff}
.setting-left{display:flex;align-items:center;gap:8px;width:120px}
.setting-name-vertical{font-weight:700;line-height:1;display:flex;flex-direction:column;align-items:center;gap:0;padding:0 2px}
.switch{position:relative;width:44px;height:24px;background:#e6e6e6;border-radius:999px;cursor:pointer}
.switch .knob{position:absolute;top:3px;left:3px;width:18px;height:18px;border-radius:50%;background:#fff;transition:all .18s}
.switch.on{background:var(--accent)}
.switch.on .knob{left:23px}
.counter{display:flex;align-items:center;gap:6px}
.counter button{width:28px;height:28px;border-radius:6px;border:1px solid #eee;background:#fff;cursor:pointer}
.counter .value{min-width:28px;text-align:center;font-weight:700}

/* hide the right-side name/value in settings (user requested) - nothing to style */

@media(max-width:900px){
  .left-column{display:none}
  .main{flex-direction:column}
}

/* svg text small */
.svg-text-small{font-size:11px;font-weight:700;dominant-baseline:middle;text-anchor:middle}

/* label tspan style */
.col-label-tspan{font-size:12px;fill:#111;font-weight:700}
</style>
</head>
<body>
<div class="app">
  <header>
    <div id="logo">素早さ早見表</div>
    <div style="flex:1"></div>
  </header>

  <!-- tabs -->
  <div class="tabs" role="tablist" aria-label="表示タブ">
    <div class="tab active" id="tab-overview">早見表</div>
    <div class="tab" id="tab-settings">設定</div>
  </div>

  <div class="controls">
    <div class="search-wrap">
      <input id="search-box" type="text" placeholder="ポケモン名を検索（例: ピカチュウ）" autocomplete="off" />
      <div id="suggestions" class="suggestions" style="display:none"></div>
    </div>
    <div style="width:12px"></div>
  </div>

  <div class="main" id="main-content">
    <div class="left-column" id="left-column">
      <div class="axis-title">縦軸: すばやさ</div>
      <div class="list-area" id="list-area">
        <!-- pokemon cards -->
      </div>
    </div>

    <div class="canvas-wrap" id="overview-wrap" aria-live="polite">
      <div class="svg-area" id="svg-area">
        <div style="width:100%;display:flex;align-items:center;justify-content:center;color:var(--muted)">
          ポケモンを検索して追加してください
        </div>
      </div>
      <div class="legend" id="legend">
        <div><span class="dot" style="background:var(--accent)"></span> 実数値 (通常)</div>
        <div><span class="dot" style="background:var(--change-blue)"></span> 実数値 (変化後)</div>
      </div>
    </div>

    <div class="settings-wrap" id="settings-wrap" style="display:none">
      <div style="padding:6px 0;color:var(--muted);font-size:13px">各ポケモンごとにスカーフ・まひ・能力変化を設定します。設定が1つでも有効なポケモンは、グラフに「通常」と「変化後」が同時に表示されます。</div>
      <div class="settings-list" id="settings-list">
        <!-- 全体 と 個別設定が入る -->
      </div>
    </div>
  </div>

  <footer style="text-align:center;padding:18px 0;color:var(--muted);font-size:13px">© Speed Chart</footer>
</div>

<script>
/*
  修正版 index.html
  - CSV は name,base,dex のヘッダ（または同列順）を想定
  - dex はポケモン徹底攻略の図鑑画像取得に使用
  - 「全体」設定の実装（常に先頭に表示）
  - 新規追加は全体設定を継承
  - 赤・青丸のサイズを統一（r=14）
  - 列幅を狭め、グラフ上下余白を削減
*/

let DB = {}; // name => { base: number, dex: string|null }
let globalSettings = { scarf:false, para:false, boost:0 }; // "全体" の設定

// displayed: array of { id, name, base, dex, values:{no_ev,neutral,max}, settings:{scarf,para,boost} }
let displayed = [];

const searchBox = document.getElementById('search-box');
const suggestionsEl = document.getElementById('suggestions');
const listArea = document.getElementById('list-area');
const svgArea = document.getElementById('svg-area');
const settingsList = document.getElementById('settings-list');
const tabOverview = document.getElementById('tab-overview');
const tabSettings = document.getElementById('tab-settings');
const overviewWrap = document.getElementById('overview-wrap');
const settingsWrap = document.getElementById('settings-wrap');

async function loadCSV(){
  try {
    const res = await fetch('pokemon_speeds.csv?_=' + Date.now());
    if(!res.ok) throw new Error('no csv');
    const text = await res.text();
    const lines = text.trim().split('\n').filter(Boolean);
    if(lines.length === 0) throw new Error('empty csv');
    // check header to detect columns
    const header = lines[0].split(',').map(h=>h.trim().toLowerCase());
    let nameIdx=0, baseIdx=1, dexIdx=2;
    if(header[0].match(/[a-z\u30a1-\u30f4]/i) && header.some(h=>h.includes('name')||h.includes('名前'))){
      // header present: detect cols
      for(let i=0;i<header.length;i++){
        const h = header[i];
        if(h.includes('name') || h.includes('名前')) nameIdx=i;
        if(h.includes('base') || h.includes('種族値')) baseIdx=i;
        if(h.includes('dex') || h.includes('図鑑') || h.includes('番号') || h.includes('no')) dexIdx=i;
      }
      lines.shift(); // remove header
    } else {
      // assume order name,base,dex
      nameIdx=0;baseIdx=1;dexIdx=2;
    }
    lines.forEach(line=>{
      const cols = parseCSVLine(line);
      const name = (cols[nameIdx]||'').trim();
      const base = parseInt((cols[baseIdx]||'').trim());
      const dex = (cols[dexIdx]||'').trim() || null;
      if(name && !Number.isNaN(base)){
        DB[name] = { base: base, dex: dex };
      }
    });
  } catch(e){
    // fallback minimal DB (with dex where possible)
    DB = {
      'ピカチュウ':{base:90, dex:'025'},
      'ガブリアス':{base:102, dex:'445'},
      'ドラパルト':{base:142, dex:'887'},
      'マスカーニャ':{base:110, dex:'908'}
    };
  }
}

// csv line parser that handles quoted commas simply
function parseCSVLine(line){
  const res=[];
  let cur=''; let inQ=false;
  for(let i=0;i<line.length;i++){
    const ch = line[i];
    if(ch === '"' ){ inQ = !inQ; continue; }
    if(ch === ',' && !inQ){ res.push(cur); cur=''; continue; }
    cur += ch;
  }
  res.push(cur);
  return res;
}

function calcValues(base){
  const no_ev = Math.floor(base + 20);
  const neutral = Math.floor(base + 52);
  const max = Math.floor(neutral * 1.1);
  return { no_ev, neutral, max };
}

function renderSuggestions(q){
  const ql = q.trim();
  if(!ql){ suggestionsEl.style.display='none'; return; }
  const keys = Object.keys(DB);
  const matches = keys.filter(n=> n.includes(ql)).slice(0,20);
  if(matches.length===0){ suggestionsEl.style.display='none'; return; }
  suggestionsEl.innerHTML = matches.map(m=> `<div data-name="${m}">${m}</div>`).join('');
  suggestionsEl.style.display='block';
  suggestionsEl.querySelectorAll('div').forEach(d=>{
    d.onclick = ()=> {
      addPokemon(d.dataset.name);
      searchBox.value = '';
      suggestionsEl.style.display='none';
      searchBox.focus();
    }
  });
}

function addPokemon(name){
  if(!DB[name]) return;
  if(displayed.find(p=>p.name===name)) return;
  const entry = DB[name];
  const base = entry.base;
  const dex = entry.dex || null;
  const values = calcValues(base);
  const id = 'p' + Date.now() + Math.floor(Math.random()*1000);
  // inherit globalSettings
  const s = { scarf: globalSettings.scarf, para: globalSettings.para, boost: globalSettings.boost };
  displayed.push({ id, name, base, dex, values, settings: s });
  renderList();
  renderSettings();
  renderGraph();
}

function removePokemon(id){
  displayed = displayed.filter(p=>p.id !== id);
  renderList();
  renderSettings();
  renderGraph();
}

function renderList(){
  listArea.innerHTML = '';
  if(displayed.length===0){
    const msg = document.createElement('div');
    msg.style.color = 'var(--muted)';
    msg.style.padding = '12px';
    msg.textContent = '追加したポケモンはここに表示されます。';
    listArea.appendChild(msg);
    return;
  }
  displayed.forEach(p=>{
    const div = document.createElement('div');
    div.className = 'pokemon-card';
    const chars = Array.from(p.name).map(c=>`<span>${c}</span>`).join('');
    const iconHtml = p.dex ? `<div class="poke-icon"><img src="${iconUrlFromDex(p.dex)}" alt="${p.name}" onerror="this.style.display='none'"/></div>` : `<div class="poke-icon">⚪</div>`;
    div.innerHTML = `
      ${iconHtml}
      <div style="display:flex;align-items:center;gap:8px">
        <div class="poke-name-vertical">${chars}</div>
        <div style="margin-left:6px">
          <div style="font-weight:700">${p.name}</div>
          <div class="base-speed">種族値: ${p.base}</div>
        </div>
      </div>
      <div class="card-meta">
        <button class="remove-btn" data-id="${p.id}">削除</button>
      </div>
    `;
    listArea.appendChild(div);
  });
  listArea.querySelectorAll('.remove-btn').forEach(btn=>{
    btn.onclick = ()=> removePokemon(btn.dataset.id);
  });
}

// settings UI, includes "全体" card at top
function renderSettings(){
  settingsList.innerHTML = '';
  // 全体カード (always present)
  const allCard = document.createElement('div');
  allCard.className = 'setting-card';
  allCard.innerHTML = `
    <div class="setting-left">
      <div class="poke-icon"><!-- empty: 全体アイコンなし --></div>
      <div style="font-weight:700; padding-left:6px">全体</div>
    </div>
    <div style="flex:1;display:flex;align-items:center;gap:18px">
      <div style="display:flex;align-items:center;gap:8px">
        <div style="font-size:13px;color:var(--muted);margin-right:6px">スカーフ</div>
        <div class="switch ${globalSettings.scarf ? 'on' : ''}" data-key="global-scarf"><div class="knob"></div></div>
      </div>
      <div style="display:flex;align-items:center;gap:8px">
        <div style="font-size:13px;color:var(--muted);margin-right:6px">まひ</div>
        <div class="switch ${globalSettings.para ? 'on' : ''}" data-key="global-para"><div class="knob"></div></div>
      </div>
      <div style="display:flex;align-items:center;gap:8px">
        <div style="font-size:13px;color:var(--muted);margin-right:8px">能力変化</div>
        <div class="counter" data-key="global-boost">
          <button class="dec" data-key="global-dec">−</button>
          <div class="value" data-key="global-val">${globalSettings.boost}</div>
          <button class="inc" data-key="global-inc">＋</button>
        </div>
        <div style="color:var(--muted);font-size:12px;margin-left:8px">（-6〜+6）</div>
      </div>
    </div>
  `;
  settingsList.appendChild(allCard);

  // bind handlers for global
  allCard.querySelector('[data-key="global-scarf"]').onclick = ()=>{
    globalSettings.scarf = !globalSettings.scarf;
    // apply to all existing pokemons (overwrite)
    displayed.forEach(p=> p.settings.scarf = globalSettings.scarf);
    renderSettings();
    renderGraph();
  };
  allCard.querySelector('[data-key="global-para"]').onclick = ()=>{
    globalSettings.para = !globalSettings.para;
    displayed.forEach(p=> p.settings.para = globalSettings.para);
    renderSettings();
    renderGraph();
  };
  allCard.querySelector('[data-key="global-dec"]').onclick = ()=>{
    if(globalSettings.boost > -6) globalSettings.boost--;
    displayed.forEach(p=> p.settings.boost = globalSettings.boost);
    renderSettings();
    renderGraph();
  };
  allCard.querySelector('[data-key="global-inc"]').onclick = ()=>{
    if(globalSettings.boost < 6) globalSettings.boost++;
    displayed.forEach(p=> p.settings.boost = globalSettings.boost);
    renderSettings();
    renderGraph();
  };

  // individual cards
  if(displayed.length===0){
    const msg = document.createElement('div');
    msg.style.color = 'var(--muted)';
    msg.style.padding = '12px 0';
    msg.textContent = 'ポケモンを追加するとここにカードが表示されます。';
    settingsList.appendChild(msg);
    return;
  }

  displayed.forEach(p=>{
    const card = document.createElement('div');
    card.className = 'setting-card';
    const chars = Array.from(p.name).map(c=>`<span>${c}</span>`).join('');
    const iconHtml = p.dex ? `<div class="poke-icon"><img src="${iconUrlFromDex(p.dex)}" alt="${p.name}" onerror="this.style.display='none'"/></div>` : `<div class="poke-icon">⚪</div>`;
    card.innerHTML = `
      <div class="setting-left">
        ${iconHtml}
        <div class="setting-name-vertical">${chars}</div>
      </div>
      <div style="flex:1;display:flex;align-items:center;gap:18px">
        <div style="display:flex;align-items:center;gap:8px">
          <div style="font-size:13px;color:var(--muted);margin-right:6px">スカーフ</div>
          <div class="switch ${p.settings.scarf ? 'on' : ''}" data-id="${p.id}" data-key="scarf"><div class="knob"></div></div>
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          <div style="font-size:13px;color:var(--muted);margin-right:6px">まひ</div>
          <div class="switch ${p.settings.para ? 'on' : ''}" data-id="${p.id}" data-key="para"><div class="knob"></div></div>
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          <div style="font-size:13px;color:var(--muted);margin-right:8px">能力変化</div>
          <div class="counter" data-id="${p.id}">
            <button class="dec" data-id="${p.id}">−</button>
            <div class="value" data-id="${p.id}">${p.settings.boost}</div>
            <button class="inc" data-id="${p.id}">＋</button>
          </div>
        </div>
      </div>
    `;
    settingsList.appendChild(card);
  });

  // attach handlers for individual cards
  settingsList.querySelectorAll('.switch[data-key="scarf"]').forEach(sw=>{
    sw.onclick = ()=>{
      const id = sw.dataset.id;
      const p = displayed.find(x=>x.id===id);
      if(!p) return;
      p.settings.scarf = !p.settings.scarf;
      renderSettings();
      renderGraph();
    };
  });
  settingsList.querySelectorAll('.switch[data-key="para"]').forEach(sw=>{
    sw.onclick = ()=>{
      const id = sw.dataset.id;
      const p = displayed.find(x=>x.id===id);
      if(!p) return;
      p.settings.para = !p.settings.para;
      renderSettings();
      renderGraph();
    };
  });
  settingsList.querySelectorAll('.dec').forEach(b=>{
    b.onclick = ()=>{
      const id = b.dataset.id;
      const p = displayed.find(x=>x.id===id);
      if(!p) return;
      if(p.settings.boost > -6) p.settings.boost--;
      renderSettings();
      renderGraph();
    };
  });
  settingsList.querySelectorAll('.inc').forEach(b=>{
    b.onclick = ()=>{
      const id = b.dataset.id;
      const p = displayed.find(x=>x.id===id);
      if(!p) return;
      if(p.settings.boost < 6) p.settings.boost++;
      renderSettings();
      renderGraph();
    };
  });
}

// icon URL builder using 図鑑番号 (dex)
// We expect dex to be zero-padded or number string; ensure 3-digit left pad if necessary (many sites use padded numbers)
function iconUrlFromDex(dex){
  // if dex is numeric string: pad to 3
  const n = String(dex).replace(/^0+/, '') || dex;
  let pad = n;
  // if numeric and less than 1000
  if(/^\d+$/.test(n)){
    pad = n.padStart(3,'0');
  }
  // Using the URL pattern suggested earlier:
  return `https://zukan.pokemon.co.jp/zukan-api/up/images/index/${pad}_m.png`;
}

// ability multiplier calculation
function abilityMultiplier(boost){
  if(boost === 0) return 1.0;
  if(boost > 0) return (2 + boost) / 2;
  const k = Math.abs(boost);
  return 2 / (2 + k);
}

// formatting for numbers inside circles
function fmt(n){
  const v = Math.floor(n);
  if(v > 999) return String(v).slice(0,3);
  return String(v);
}

function renderGraph(){
  if(displayed.length===0){
    svgArea.innerHTML = '<div style="width:100%;display:flex;align-items:center;justify-content:center;color:var(--muted)">ポケモンを検索して追加してください</div>';
    return;
  }

  // gather values (including changed ones) to set axis
  const allVals = [];
  displayed.forEach(p=>{
    const v = p.values;
    allVals.push(v.no_ev, v.neutral, v.max);
    const s = p.settings;
    const hasChange = s.scarf || s.para || s.boost !== 0;
    if(hasChange){
      const m = (s.scarf ? 1.5 : 1.0) * (s.para ? 0.5 : 1.0) * abilityMultiplier(s.boost);
      allVals.push(Math.floor(v.no_ev * m), Math.floor(v.neutral * m), Math.floor(v.max * m));
    }
  });

  const vMin = Math.max(0, Math.min(...allVals));
  const vMax = Math.max(...allVals);

  // reduce top/bottom slack to minimum
  const pad = Math.max(4, Math.round((vMax - vMin) * 0.03)); // small percentage padding
  const axisMin = Math.max(0, vMin - pad);
  const axisMax = vMax + pad;

  const height = 520; // tall per request
  const colW = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--col-width')) || 70;
  const gap = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--col-gap')) || 6;
  const blueOffset = 30; // as decided
  const width = Math.max(420, displayed.length * (colW + gap) + 160);
  const axisTicks = 6;

  const ticks = [];
  for(let i=0;i<=axisTicks;i++){
    const val = Math.round(axisMin + (axisMax - axisMin) * ( (axisTicks - i) / axisTicks ));
    ticks.push(val);
  }

  const toY = (val) => {
    const ratio = (val - axisMin) / (axisMax - axisMin);
    // tighten top/bottom margins: map [0,1] -> [12, height-40]
    return Math.round((1 - ratio) * (height - 52)) + 12;
  };

  // build column svg parts
  let cols = '';
  displayed.forEach((p, idx)=>{
    const colX = 80 + idx * (colW + gap);
    const vals = p.values;
    const y_no = toY(vals.no_ev);
    const y_n = toY(vals.neutral);
    const y_m = toY(vals.max);

    const s = p.settings;
    const hasChange = s.scarf || s.para || s.boost !== 0;
    let changed = null;
    if(hasChange){
      const m = (s.scarf ? 1.5 : 1.0) * (s.para ? 0.5 : 1.0) * abilityMultiplier(s.boost);
      changed = {
        no: Math.floor(vals.no_ev * m),
        neutral: Math.floor(vals.neutral * m),
        max: Math.floor(vals.max * m)
      };
    }

    // connector
    const connector = `<line x1="${colX}" y1="${y_no}" x2="${colX}" y2="${y_m}" stroke="#f2f2f2" stroke-width="6" stroke-linecap="round"></line>`;

    // circles: both red and blue use r=14, text small unified
    const rBig = 14;
    const normal = `
      <g>
        <circle cx="${colX}" cy="${y_no}" r="${rBig}" fill="#fff" stroke="${getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || '#ff3b3b'}" stroke-width="3"></circle>
        <text class="svg-text-small" x="${colX}" y="${y_no+3}">${fmt(vals.no_ev)}</text>

        <circle cx="${colX}" cy="${y_n}" r="${rBig}" fill="#fff" stroke="${getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || '#ff3b3b'}" stroke-width="3"></circle>
        <text class="svg-text-small" x="${colX}" y="${y_n+3}">${fmt(vals.neutral)}</text>

        <circle cx="${colX}" cy="${y_m}" r="${rBig}" fill="#fff" stroke="${getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || '#ff3b3b'}" stroke-width="3"></circle>
        <text class="svg-text-small" x="${colX}" y="${y_m+3}">${fmt(vals.max)}</text>
      </g>
    `;

    let changedHtml = '';
    if(changed){
      const y_no_c = toY(changed.no);
      const y_n_c = toY(changed.neutral);
      const y_m_c = toY(changed.max);
      const cxOff = colX + blueOffset;
      changedHtml = `
        <g>
          <circle cx="${cxOff}" cy="${y_no_c}" r="${rBig}" fill="#fff" stroke="${getComputedStyle(document.documentElement).getPropertyValue('--change-blue').trim() || '#2b85ff'}" stroke-width="3"></circle>
          <text class="svg-text-small" x="${cxOff}" y="${y_no_c+3}" fill="#000">${fmt(changed.no)}</text>

          <circle cx="${cxOff}" cy="${y_n_c}" r="${rBig}" fill="#fff" stroke="${getComputedStyle(document.documentElement).getPropertyValue('--change-blue').trim() || '#2b85ff'}" stroke-width="3"></circle>
          <text class="svg-text-small" x="${cxOff}" y="${y_n_c+3}" fill="#000">${fmt(changed.neutral)}</text>

          <circle cx="${cxOff}" cy="${y_m_c}" r="${rBig}" fill="#fff" stroke="${getComputedStyle(document.documentElement).getPropertyValue('--change-blue').trim() || '#2b85ff'}" stroke-width="3"></circle>
          <text class="svg-text-small" x="${cxOff}" y="${y_m_c+3}" fill="#000">${fmt(changed.max)}</text>
        </g>
      `;
    }

    // vertical name below column using tspan (each char in its own tspan)
    const nameTspan = Array.from(p.name).map((c,i)=>`<tspan class="col-label-tspan" x="${colX}" dy="${i===0?0:14}">${c}</tspan>`).join('');

    // label Y position
    const labelY = height + 18;

    // delete button group
    const deleteBtnId = 'del-' + p.id;
    const label = `
      <g>
        <text x="${colX}" y="${labelY}" font-size="12" text-anchor="middle" fill="#111" font-weight="700">
          ${nameTspan}
        </text>
      </g>
    `;
    cols += connector + normal + changedHtml + label + `
      <g id="${deleteBtnId}" cursor="pointer">
        <rect x="${colX-22}" y="${labelY+8}" width="44" height="28" rx="6" fill="#fff" stroke="#f3f3f3"></rect>
        <text x="${colX}" y="${labelY+27}" font-size="14" text-anchor="middle" fill="#111">✖️</text>
      </g>
    `;
  });

  const svg = `
    <svg width="${width}" height="${height + 120}" viewBox="0 0 ${width} ${height + 120}" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="素早さグラフ">
      <style> text{font-family: "Noto Sans JP", sans-serif} </style>
      <g transform="translate(40,0)">
        ${ticks.map((t,i)=>{
          const y = Math.round((height - 52) * (i/ (ticks.length-1))) + 12;
          return `<text x="-12" y="${y+5}" text-anchor="end" fill="${getComputedStyle(document.documentElement).getPropertyValue('--muted') || '#666'}">${t}</text>
                  <line x1="0" y1="${y}" x2="${width-140}" y2="${y}" stroke="#f5f5f5" stroke-width="1" />`;
        }).join('')}
      </g>
      <g transform="translate(0,0)">${cols}</g>
    </svg>
  `;
  svgArea.innerHTML = svg;

  // attach delete handlers
  displayed.forEach(p=>{
    const el = document.getElementById('del-' + p.id);
    if(el){
      el.style.cursor = 'pointer';
      el.addEventListener('click', ()=> removePokemon(p.id));
    }
  });
}

// events
searchBox.addEventListener('input', (e)=> {
  renderSuggestions(e.target.value);
});
searchBox.addEventListener('keydown', (e)=>{
  if(e.key === 'Enter'){
    const val = e.target.value.trim();
    if(val && DB[val]){ addPokemon(val); e.target.value=''; suggestionsEl.style.display='none'; }
  } else if(e.key === 'Escape'){
    suggestionsEl.style.display='none';
  }
});
document.addEventListener('click', (e)=>{
  if(!document.querySelector('.search-wrap').contains(e.target)){
    suggestionsEl.style.display='none';
  }
});

// tabs
tabOverview.addEventListener('click', ()=>{
  tabOverview.classList.add('active');
  tabSettings.classList.remove('active');
  overviewWrap.style.display = '';
  settingsWrap.style.display = 'none';
});
tabSettings.addEventListener('click', ()=>{
  tabOverview.classList.remove('active');
  tabSettings.classList.add('active');
  overviewWrap.style.display = 'none';
  settingsWrap.style.display = '';
  renderSettings();
});

// init
loadCSV().then(()=> {
  // optionally preload some pokemon for demo
  // addPokemon('ピカチュウ'); addPokemon('ガブリアス');
});
</script>
</body>
</html>
