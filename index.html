<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ポケモン素早さ早見表</title>
<style>
:root{
  --bg:#ffffff;
  --accent:#ff3b3b; /* 赤：通常 */
  --change-blue:#2b85ff; /* 青：変化後 */
  --text:#111;
  --muted:#666;
  --card:#fff;
  --gap:10px;
  --max-width:1200px;
  font-family: "Noto Sans JP", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  --col-width:100px; /* 列幅（狭め） */
  --col-gap:12px;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);padding-bottom:60px}
.app{max-width:var(--max-width);margin:0 auto;padding:12px}
header{display:flex;align-items:center;gap:12px;padding:8px 0}
#logo{font-weight:700;font-size:18px}
.tabs{display:flex;gap:8px;border-bottom:1px solid #eee}
.tab{padding:10px 14px;cursor:pointer;border-radius:8px 8px 0 0;color:var(--muted)}
.tab.active{background:#fff;border:1px solid #eee;border-bottom:1px solid #fff;color:var(--text);font-weight:700}
.controls{display:flex;gap:8px;align-items:center;width:100%;position:relative;margin-top:10px}
.search-wrap{flex:1;position:relative}
#search-box{width:100%;padding:10px 12px;border:1px solid #ddd;border-radius:8px;font-size:16px}
.suggestions{position:absolute;left:0;right:0;background:#fff;border:1px solid #eee;border-top:none;max-height:220px;overflow:auto;z-index:30}
.suggestions div{padding:8px 10px;cursor:pointer}
.suggestions div:hover{background:#fafafa}

/* layout */
.main{display:flex;gap:12px;margin-top:12px}
.left-column{width:160px}
.axis-title{font-size:14px;color:var(--muted);margin-bottom:8px}
.list-area{display:flex;flex-direction:column;gap:8px;max-height:560px;overflow:auto}
.pokemon-card{display:flex;align-items:center;gap:8px;background:var(--card);border:1px solid #eee;padding:8px;border-radius:8px}
.poke-icon{width:44px;height:44px;border-radius:8px;background:#f5f5f5;display:flex;align-items:center;justify-content:center;font-weight:700;color:#777}
.poke-name-vertical{font-weight:700;line-height:1;display:flex;flex-direction:column;align-items:center;gap:0;padding:0 2px}
.poke-name-vertical span{display:block}
.card-meta{margin-left:auto;display:flex;flex-direction:column;align-items:flex-end;gap:6px}
.remove-btn{background:transparent;border:1px solid #f0f0f0;padding:6px 8px;border-radius:6px;font-size:12px;color:var(--muted);cursor:pointer}
.remove-btn:hover{background:#fafafa}
.base-speed{font-size:12px;color:var(--muted)}

/* canvas */
.canvas-wrap{flex:1;min-height:520px;background:#fff;border:1px solid #eee;border-radius:8px;padding:12px;display:flex;flex-direction:column}
.svg-area{flex:1;display:flex;align-items:stretch;justify-content:center;padding:6px;overflow:auto}
.legend{display:flex;gap:12px;align-items:center;padding-top:8px;font-size:13px;color:var(--muted)}
.legend .dot{width:14px;height:14px;border-radius:50%;display:inline-block}

/* SVG marker sizes */
.marker-large-r=22;

/* settings tab */
.settings-list{display:flex;flex-direction:column;gap:8px;padding:8px 0;max-height:520px;overflow:auto}
.setting-card{display:flex;align-items:center;gap:12px;padding:8px;border:1px solid #eee;border-radius:8px;background:#fff}
.setting-name{width:60px}
.toggle{display:inline-flex;align-items:center;gap:8px}
.switch{position:relative;width:44px;height:24px;background:#e6e6e6;border-radius:999px;cursor:pointer}
.switch .knob{position:absolute;top:3px;left:3px;width:18px;height:18px;border-radius:50%;background:#fff;transition:all .18s}
.switch.on{background:var(--accent)}
.switch.on .knob{left:23px}
.counter{display:flex;align-items:center;gap:6px}
.counter button{width:28px;height:28px;border-radius:6px;border:1px solid #eee;background:#fff;cursor:pointer}
.counter .value{min-width:28px;text-align:center;font-weight:700}

/* responsive */
@media(max-width:900px){
  .left-column{display:none}
  .main{flex-direction:column}
}

/* small text inside circles (both normal and change will be small and same size) */
.svg-text-small{font-size:11px;font-weight:700;dominant-baseline:middle;text-anchor:middle}

/* vertical labels under columns container adjustments */
.col-label-vertical{display:flex;flex-direction:column;align-items:center;gap:0;padding-top:6px}
.col-delete-btn{margin-top:6px;background:transparent;border:1px solid #f3f3f3;padding:6px 8px;border-radius:6px;cursor:pointer}
.col-delete-btn:hover{background:#fafafa}
</style>
</head>
<body>
<div class="app">
  <header>
    <div id="logo">素早さ早見表</div>
    <div style="flex:1"></div>
  </header>

  <!-- tabs -->
  <div class="tabs" role="tablist" aria-label="表示タブ">
    <div class="tab active" id="tab-overview">早見表</div>
    <div class="tab" id="tab-settings">設定</div>
  </div>

  <div class="controls">
    <div class="search-wrap">
      <input id="search-box" type="text" placeholder="ポケモン名を検索（例: ピカチュウ）" autocomplete="off" />
      <div id="suggestions" class="suggestions" style="display:none"></div>
    </div>
    <div style="width:12px"></div>
  </div>

  <div class="main" id="main-content">
    <div class="left-column" id="left-column">
      <div class="axis-title">縦軸: すばやさ</div>
      <div class="list-area" id="list-area">
        <!-- pokemon cards -->
      </div>
    </div>

    <div class="canvas-wrap" id="overview-wrap" aria-live="polite">
      <div class="svg-area" id="svg-area">
        <div style="width:100%;display:flex;align-items:center;justify-content:center;color:var(--muted)">
          ポケモンを検索して追加してください
        </div>
      </div>
      <div class="legend" id="legend">
        <div><span class="dot" style="background:var(--accent)"></span> 実数値 (通常)</div>
        <div><span class="dot" style="background:var(--change-blue)"></span> 実数値 (変化後)</div>
      </div>
    </div>

    <!-- settings tab, hidden by default -->
    <div class="canvas-wrap" id="settings-wrap" style="display:none">
      <div style="padding:6px 0;color:var(--muted);font-size:13px">各ポケモンごとにスカーフ・まひ・能力変化を設定します。設定が1つでも有効なポケモンは、グラフに「通常」と「変化後」が同時に表示されます。</div>
      <div class="settings-list" id="settings-list">
        <!-- dynamic settings cards -->
        <div style="color:var(--muted);padding:12px 0">ポケモンを追加するとここにカードが表示されます。</div>
      </div>
    </div>
  </div>

  <footer style="text-align:center;padding:18px 0;color:var(--muted);font-size:13px">© Speed Chart</footer>
</div>

<script>
/*
  フル書き直し版
  - 機能:
    - 検索でポケモン追加（CSVがあるときは読み込み。なければ簡易DB）
    - 早見表タブ（SVGグラフ）
    - 設定タブ（ポケモンごとのスカーフ・まひ・能力変化）
    - 実数値（通常）と実数値（変化後）を表示（変化後は青、少し横ずらし）
    - ポケモン名を縦書き（1文字ずつ）
    - 各ポケモンの下に✖️ボタン（削除）
*/

let DB = {};
async function loadCSV(){
  try {
    const res = await fetch('pokemon_speeds.csv?_=' + Date.now());
    if(!res.ok) throw new Error('no csv');
    const text = await res.text();
    const lines = text.trim().split('\n').filter(Boolean);
    const header = lines.shift();
    lines.forEach(line=>{
      // simple split, expect "名前,値"
      const parts = line.split(',');
      const name = parts[0].trim();
      const base = parseInt(parts[1]);
      if(name && !Number.isNaN(base)) DB[name] = base;
    });
  } catch(e){
    // fallback DB
    DB = {
      'ピカチュウ':90, 'ガブリアス':102, 'カイリュー':80, 'ドラパルト':142, 'バンギラス':61, 'ミミッキュ':96, 'ヒヒダルマ':100
    };
  }
}
function calcValues(base){
  // keep same base computations as既存
  const no_ev = Math.floor(base + 20);
  const neutral = Math.floor(base + 52);
  const max = Math.floor(neutral * 1.1);
  return { base, no_ev, neutral, max };
}

// displayed array: objects {id,name,base,values,settings:{scarf:false,para:false,boost:0}}
let displayed = [];

const searchBox = document.getElementById('search-box');
const suggestionsEl = document.getElementById('suggestions');
const listArea = document.getElementById('list-area');
const svgArea = document.getElementById('svg-area');
const settingsList = document.getElementById('settings-list');
const tabOverview = document.getElementById('tab-overview');
const tabSettings = document.getElementById('tab-settings');
const overviewWrap = document.getElementById('overview-wrap');
const settingsWrap = document.getElementById('settings-wrap');

function renderSuggestions(q){
  const ql = q.trim();
  if(!ql){ suggestionsEl.style.display='none'; return; }
  const keys = Object.keys(DB);
  const matches = keys.filter(n=> n.includes(ql)).slice(0,20);
  if(matches.length===0){ suggestionsEl.style.display='none'; return; }
  suggestionsEl.innerHTML = matches.map(m=> `<div data-name="${m}">${m}</div>`).join('');
  suggestionsEl.style.display='block';
  // click handlers
  suggestionsEl.querySelectorAll('div').forEach(d=>{
    d.onclick = ()=> {
      addPokemon(d.dataset.name);
      searchBox.value = '';
      suggestionsEl.style.display='none';
      searchBox.focus();
    }
  });
}

function addPokemon(name){
  if(!DB[name]) return;
  if(displayed.find(p=>p.name===name)) return;
  const base = DB[name];
  const values = calcValues(base);
  const id = 'p' + Date.now() + Math.floor(Math.random()*1000);
  displayed.push({
    id, name, base, values,
    settings: { scarf:false, para:false, boost:0 }
  });
  renderList();
  renderSettings();
  renderGraph();
}

function removePokemon(id){
  displayed = displayed.filter(p=>p.id !== id);
  renderList();
  renderSettings();
  renderGraph();
}

function renderList(){
  listArea.innerHTML = '';
  if(displayed.length===0){
    const msg = document.createElement('div');
    msg.style.color = 'var(--muted)';
    msg.style.padding = '12px';
    msg.textContent = '追加したポケモンはここに表示されます。';
    listArea.appendChild(msg);
    return;
  }
  displayed.forEach(p=>{
    const div = document.createElement('div');
    div.className = 'pokemon-card';
    // vertical name: split chars
    const chars = Array.from(p.name).map(c=>`<span>${c}</span>`).join('');
    div.innerHTML = `
      <div class="poke-icon" aria-hidden="true">⚪</div>
      <div style="display:flex;align-items:center;gap:8px">
        <div class="poke-name-vertical">${chars}</div>
        <div style="margin-left:6px">
          <div style="font-weight:700">${p.name}</div>
          <div class="base-speed">種族値: ${p.base}</div>
        </div>
      </div>
      <div class="card-meta">
        <button class="remove-btn" data-id="${p.id}">削除</button>
      </div>
    `;
    listArea.appendChild(div);
  });
  listArea.querySelectorAll('.remove-btn').forEach(btn=>{
    btn.onclick = ()=> removePokemon(btn.dataset.id);
  });
}

// settings UI
function renderSettings(){
  settingsList.innerHTML = '';
  if(displayed.length===0){
    settingsList.innerHTML = '<div style="color:var(--muted);padding:12px 0">ポケモンを追加するとここにカードが表示されます。</div>';
    return;
  }
  displayed.forEach(p=>{
    const card = document.createElement('div');
    card.className = 'setting-card';
    const chars = Array.from(p.name).map(c=>`<span>${c}</span>`).join('');
    card.innerHTML = `
      <div style="display:flex;align-items:center;gap:8px">
        <div class="poke-icon" aria-hidden="true">⚪</div>
        <div class="setting-name">
          <div class="poke-name-vertical">${chars}</div>
        </div>
      </div>
      <div style="flex:1">
        <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
          <div class="toggle">
            <div style="font-size:13px;color:var(--muted);margin-right:6px">スカーフ</div>
            <div class="switch ${p.settings.scarf ? 'on' : ''}" data-id="${p.id}" data-key="scarf"><div class="knob"></div></div>
          </div>
          <div class="toggle">
            <div style="font-size:13px;color:var(--muted);margin-right:6px">まひ</div>
            <div class="switch ${p.settings.para ? 'on' : ''}" data-id="${p.id}" data-key="para"><div class="knob"></div></div>
          </div>
          <div style="display:flex;align-items:center;gap:8px">
            <div style="font-size:13px;color:var(--muted)">能力変化</div>
            <div class="counter" data-id="${p.id}">
              <button class="dec" data-id="${p.id}">−</button>
              <div class="value" data-id="${p.id}">${p.settings.boost}</div>
              <button class="inc" data-id="${p.id}">＋</button>
            </div>
            <div style="color:var(--muted);font-size:12px;margin-left:8px">（-6〜+6）</div>
          </div>
        </div>
      </div>
      <div style="min-width:120px;text-align:right">
        <div style="font-weight:700">${p.name}</div>
        <div style="font-size:12px;color:var(--muted)">実数値: ${p.values.no_ev}</div>
      </div>
    `;
    settingsList.appendChild(card);
  });

  // attach handlers
  settingsList.querySelectorAll('.switch').forEach(sw=>{
    sw.onclick = (e)=>{
      const id = sw.dataset.id;
      const key = sw.dataset.key;
      const p = displayed.find(x=>x.id===id);
      if(!p) return;
      p.settings[key] = !p.settings[key];
      renderSettings();
      renderGraph();
    }
  });
  settingsList.querySelectorAll('.dec').forEach(b=>{
    b.onclick = ()=>{
      const id = b.dataset.id;
      const p = displayed.find(x=>x.id===id);
      if(!p) return;
      if(p.settings.boost > -6) p.settings.boost--;
      renderSettings();
      renderGraph();
    }
  });
  settingsList.querySelectorAll('.inc').forEach(b=>{
    b.onclick = ()=>{
      const id = b.dataset.id;
      const p = displayed.find(x=>x.id===id);
      if(!p) return;
      if(p.settings.boost < 6) p.settings.boost++;
      renderSettings();
      renderGraph();
    }
  });
}

// compute change multiplier from settings.boost
function abilityMultiplier(boost){
  if(boost === 0) return 1.0;
  if(boost > 0){
    return (2 + boost) / 2;
  } else {
    const k = Math.abs(boost);
    return 2 / (2 + k);
  }
}

// helper formatting: small numbers inside circles (max 3 digits)
function fmt(n){
  const v = Math.floor(n);
  if(v > 999) return String(v).slice(0,3);
  return String(v);
}

function renderGraph(){
  if(displayed.length===0){
    svgArea.innerHTML = '<div style="width:100%;display:flex;align-items:center;justify-content:center;color:var(--muted)">ポケモンを検索して追加してください</div>';
    return;
  }
  // gather all values to set axis
  const allVals = [];
  displayed.forEach(p=>{
    const vals = p.values;
    allVals.push(vals.no_ev, vals.neutral, vals.max);
    // if any setting exists, compute changed values
    const s = p.settings;
    const hasChange = s.scarf || s.para || s.boost !== 0;
    if(hasChange){
      const m = (s.scarf ? 1.5 : 1.0) * (s.para ? 0.5 : 1.0) * abilityMultiplier(s.boost);
      allVals.push(Math.floor(vals.no_ev * m), Math.floor(vals.neutral * m), Math.floor(vals.max * m));
    }
  });
  const vMin = Math.max(0, Math.min(...allVals) - 8);
  const vMax = Math.max(...allVals) + 8;

  const height = 520; // widened vertically per request
  const colW = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--col-width')) || 100;
  const gap = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--col-gap')) || 12;
  const width = Math.max(420, displayed.length * (colW + gap) + 120);
  const axisTicks = 6;

  // ticks labels (top->bottom)
  const ticks = [];
  for(let i=0;i<=axisTicks;i++){
    const val = Math.round(vMin + (vMax - vMin) * ( (axisTicks - i) / axisTicks ));
    ticks.push(val);
  }

  const toY = (val) => {
    const ratio = (val - vMin) / (vMax - vMin);
    return Math.round((1 - ratio) * (height - 60)) + 20;
  };

  // build columns
  let cols = '';
  displayed.forEach((p, idx)=>{
    const colX = 80 + idx * (colW + gap);
    const vals = p.values;
    const y_no = toY(vals.no_ev);
    const y_n = toY(vals.neutral);
    const y_m = toY(vals.max);

    // compute changed values if any
    const s = p.settings;
    const hasChange = s.scarf || s.para || s.boost !== 0;
    let changed = null;
    if(hasChange){
      const m = (s.scarf ? 1.5 : 1.0) * (s.para ? 0.5 : 1.0) * abilityMultiplier(s.boost);
      changed = {
        no: Math.floor(vals.no_ev * m),
        neutral: Math.floor(vals.neutral * m),
        max: Math.floor(vals.max * m)
      };
    }

    // connector line (min to max)
    const connector = `<line x1="${colX}" y1="${y_no}" x2="${colX}" y2="${y_m}" stroke="#f2f2f2" stroke-width="6" stroke-linecap="round"></line>`;

    // normal circles (red border) - larger circles
    const normal = `
      <g>
        <circle cx="${colX}" cy="${y_no}" r="20" fill="#fff" stroke="${getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || '#ff3b3b'}" stroke-width="3"></circle>
        <text class="svg-text-small" x="${colX}" y="${y_no+3}">${fmt(vals.no_ev)}</text>

        <circle cx="${colX}" cy="${y_n}" r="20" fill="#fff" stroke="${getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || '#ff3b3b'}" stroke-width="3"></circle>
        <text class="svg-text-small" x="${colX}" y="${y_n+3}">${fmt(vals.neutral)}</text>

        <circle cx="${colX}" cy="${y_m}" r="20" fill="#fff" stroke="${getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || '#ff3b3b'}" stroke-width="3"></circle>
        <text class="svg-text-small" x="${colX}" y="${y_m+3}">${fmt(vals.max)}</text>
      </g>
    `;

    // changed circles (blue border) - slightly offset to the right (approx +30 px)
    let changedHtml = '';
    if(changed){
      const y_no_c = toY(changed.no);
      const y_n_c = toY(changed.neutral);
      const y_m_c = toY(changed.max);
      const cxOff = colX + 30; // small horizontal shift
      changedHtml = `
        <g>
          <circle cx="${cxOff}" cy="${y_no_c}" r="14" fill="#fff" stroke="${getComputedStyle(document.documentElement).getPropertyValue('--change-blue').trim() || '#2b85ff'}" stroke-width="3"></circle>
          <text class="svg-text-small" x="${cxOff}" y="${y_no_c+2}" fill="#000">${fmt(changed.no)}</text>

          <circle cx="${cxOff}" cy="${y_n_c}" r="14" fill="#fff" stroke="${getComputedStyle(document.documentElement).getPropertyValue('--change-blue').trim() || '#2b85ff'}" stroke-width="3"></circle>
          <text class="svg-text-small" x="${cxOff}" y="${y_n_c+2}" fill="#000">${fmt(changed.neutral)}</text>

          <circle cx="${cxOff}" cy="${y_m_c}" r="14" fill="#fff" stroke="${getComputedStyle(document.documentElement).getPropertyValue('--change-blue').trim() || '#2b85ff'}" stroke-width="3"></circle>
          <text class="svg-text-small" x="${cxOff}" y="${y_m_c+2}" fill="#000">${fmt(changed.max)}</text>
        </g>
      `;
    }

    // vertical name under column (縦書き：each char on its own line)
    const nameChars = Array.from(p.name).map(c => `<tspan x="${colX}" dy="14">${c}</tspan>`).join('');

    // delete button under each pokemon (as SVG foreignObject to make clickable)
    const deleteBtnId = 'del-' + p.id;
    // We'll place a small button-like rect and text, and also create an overlay HTML button later to attach events reliably.
    const labelY = height + 24;
    const label = `
      <g>
        <text x="${colX}" y="${labelY}" font-size="12" text-anchor="middle" fill="#111" font-weight="700">${p.name}</text>
      </g>
    `;

    // combine
    cols += connector + normal + changedHtml + label + `
      <!-- delete button area -->
      <g id="${deleteBtnId}" cursor="pointer">
        <rect x="${colX-26}" y="${labelY+8}" width="52" height="28" rx="6" fill="#fff" stroke="#f3f3f3"></rect>
        <text x="${colX}" y="${labelY+27}" font-size="14" text-anchor="middle" fill="#111">✖️</text>
      </g>
    `;
  });

  // build SVG
  const svg = `
    <svg width="${width}" height="${height + 100}" viewBox="0 0 ${width} ${height + 100}" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="素早さグラフ">
      <style> text{font-family: "Noto Sans JP", sans-serif} </style>
      <!-- axis and grid -->
      <g transform="translate(40,0)">
        ${ticks.map((t,i)=> {
          const y = Math.round((height - 60) * (i/ (ticks.length-1))) + 20;
          return `<text x="-12" y="${y+5}" text-anchor="end" fill="${getComputedStyle(document.documentElement).getPropertyValue('--muted') || '#666'}">${t}</text>
                  <line x1="0" y1="${y}" x2="${width-120}" y2="${y}" stroke="#f5f5f5" stroke-width="1" />`;
        }).join('')}
      </g>

      <!-- columns -->
      <g transform="translate(0,0)">
        ${cols}
      </g>
    </svg>
  `;
  svgArea.innerHTML = svg;

  // attach delete handlers: for each displayed pokemon id, add click handler to the group with id del-<id>
  displayed.forEach(p=>{
    const el = document.getElementById('del-' + p.id);
    if(el){
      el.style.cursor = 'pointer';
      el.addEventListener('click', ()=> {
        removePokemon(p.id);
      });
    }
  });
}

// events
searchBox.addEventListener('input', (e)=> {
  renderSuggestions(e.target.value);
});
searchBox.addEventListener('keydown', (e)=>{
  if(e.key === 'Enter'){
    const val = e.target.value.trim();
    if(val && DB[val]){ addPokemon(val); e.target.value=''; suggestionsEl.style.display='none'; }
  } else if(e.key === 'Escape'){
    suggestionsEl.style.display='none';
  }
});
document.addEventListener('click', (e)=>{
  if(!document.querySelector('.search-wrap').contains(e.target)){
    suggestionsEl.style.display='none';
  }
});

// tabs behavior
tabOverview.addEventListener('click', ()=>{
  tabOverview.classList.add('active');
  tabSettings.classList.remove('active');
  overviewWrap.style.display = '';
  settingsWrap.style.display = 'none';
});
tabSettings.addEventListener('click', ()=>{
  tabOverview.classList.remove('active');
  tabSettings.classList.add('active');
  overviewWrap.style.display = 'none';
  settingsWrap.style.display = '';
  renderSettings();
});

// init
loadCSV().then(()=> {
  // if you want, preload some pokemons for demo (commented out)
  // addPokemon('ピカチュウ'); addPokemon('ガブリアス'); addPokemon('ドラパルト');
});
</script>
</body>
</html>
